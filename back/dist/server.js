!function(e){var t={};function r(o){if(t[o])return t[o].exports;var n=t[o]={i:o,l:!1,exports:{}};return e[o].call(n.exports,n,n.exports,r),n.l=!0,n.exports}r.m=e,r.c=t,r.d=function(e,t,o){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(r.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(o,n,function(t){return e[t]}.bind(null,n));return o},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0)}({"./index.mjs":function(e,t,r){"use strict";r.r(t);var o=r("express"),n=r("body-parser"),a=r("express-jwt"),s=r("@google-cloud/translate"),i=r("@google-cloud/storage"),u=r("crypto");r("dotenv");const{Storage:l}=i,c=(new l).bucket("just-for-fun-file-storage");const p=new s.v3.TranslationServiceClient({projectId:"justforfun-283718"});var d=r("jsonwebtoken");const m=o.Router();m.get("/login/:username/:password",(e,t)=>{const r=(o=e.params.username,n=e.params.password,"alice"===o&&"monkey1"===n&&{usename:"alice",id:1});var o,n;if(r)return t.send({token:d.sign({user:r},process.env._SECRET,{algorithm:"HS512",expiresIn:"24h"})});t.status(400).send({error:"User or pass not correct"})});var g=m,f=r("cheerio"),y=r("multer"),h=(r("mime-types"),r("axios"));const w=async(e,t)=>{try{let r;if(r="/parse"===e.path?e.query.url:e.params.url,console.log(r),!r)return t.status(400).send({error:"url missing"});const{data:o}=await h.get(r.startsWith("http")?r:"http://"+r),n=f.load(o);let a=n('link[rel="icon"]');a.length||(a=n('link[rel="shortcut icon"]'),a.length||(a=null)),a&&(a=a.attr("href"));let s=n("title").text();s||(s=n('meta[property="og:title"]').attr("content")),s||(s=n('meta[name="twitter:title"]').attr("content"));let i=n('meta[property="og:image"]').attr("content");i||(i=n('meta[property="twitter:image"]').attr("content"));let u=n('meta[name="description"]').attr("content");return u||(u=n('meta[property="og:description"]').attr("content")),u||(u=n('meta[name="twitter:description"]').attr("content")),t.status(200).send({favicon:a,title:"string"==typeof s?s.trim():s,"large-image":i,snippet:"string"==typeof u?u.trim():u})}catch(e){return console.error(e),t.status(400).send({error:"Something went wrong. Check your url - Remember you need to pass your url without schema or URIEncoded. (encodeURIComponent)  "})}},x=async(e,t)=>{try{let r;if(r="/translate"===e.path?e.query.url:e.params.url,!r)return t.status(400).send({error:"url missing"});const{data:o}=await h.get(r.startsWith("http")?r:"http://"+r),n=f.load(o),a=await(async(e,t,r=null)=>{const o={parent:process.env._BUCKET_URL,contents:[e],targetLanguageCode:r||"ja"},[n]=await p.translateText({...o});return n})(n.html(),n("body").html(),e.query.lang||null);t.send(a.translations[0].translatedText)}catch(e){return console.error(e),3===e.code?t.status(400).send({error:"The page has too much content. Lets not waste the quota and test with a smaller  pagge please :)"}):t.status(400).send({error:"Something went wrong. Check your url - Remember you need to pass your url without schema or URIEncoded. (encodeURIComponent)  You can also  use query param 'url' to GET /translate"})}},b=o.Router();b.get("/parse/:url",w),b.get("/parse",w),b.get("/translate/:url",x),b.get("/translate",x),b.post("/upload",y({storage:y.memoryStorage(),limits:{fileSize:8388608}}).single("file"),async(e,t,r)=>{try{const r=e.file,o=await(async e=>new Promise((t,r)=>{const{originalname:o,buffer:n,mimetype:a}=e;var s=u.randomBytes(16).toString("hex");c.file(s).createWriteStream({resumable:!1,metadata:{contentType:a}}).on("finish",()=>{t(s)}).on("error",()=>{r("Something went wrong while uploading")}).end(n)}))(r);t.status(200).json({message:"File upload",id:o})}catch(e){r(e)}}),b.get("/download/:identifier",async(e,t)=>{try{const o=await(r=e.params.identifier,new Promise(async(e,t)=>{const o=c.file(r);let n;try{n=await o.getMetadata()}catch(e){t(e)}o.download().then((function(t){e({file:t[0],metadata:n})})).catch(e=>{console.log({e:e}),t(e)})}));t.header({"Content-Type":o.metadata[0].contentType}),t.send(o.file)}catch(e){console.error(e),t.status(e.code||404).send({error:"Not found"})}var r});var v=b;var j=o();j.use(n.urlencoded({extended:!1})),j.use(n.json());j.use(a({secret:process.env._SECRET,algorithms:["HS512"],getToken:function(e){return e.headers.authorization&&"Bearer"===e.headers.authorization.split(" ")[0]?e.headers.authorization.split(" ")[1]:e.query&&e.query.token?e.query.token:null}}).unless(e=>!!e.originalUrl.startsWith("/login"))),j.use("/",g,v);j.use((e,t,r,o)=>{((e,t)=>{const{statusCode:r,message:o}=e;t.status("UnauthorizedError"===e.name?401:r||500).json({error:o})})(e,r)}),j.listen(8080)},0:function(e,t,r){r("@babel/polyfill"),e.exports=r("./index.mjs")},"@babel/polyfill":function(e,t){e.exports=require("@babel/polyfill")},"@google-cloud/storage":function(e,t){e.exports=require("@google-cloud/storage")},"@google-cloud/translate":function(e,t){e.exports=require("@google-cloud/translate")},axios:function(e,t){e.exports=require("axios")},"body-parser":function(e,t){e.exports=require("body-parser")},cheerio:function(e,t){e.exports=require("cheerio")},crypto:function(e,t){e.exports=require("crypto")},dotenv:function(e,t){e.exports=require("dotenv")},express:function(e,t){e.exports=require("express")},"express-jwt":function(e,t){e.exports=require("express-jwt")},jsonwebtoken:function(e,t){e.exports=require("jsonwebtoken")},"mime-types":function(e,t){e.exports=require("mime-types")},multer:function(e,t){e.exports=require("multer")}});